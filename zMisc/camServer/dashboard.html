<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Mentat Voxel</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: 'Courier New', monospace;
				background: #000000;
				color: #ffffff;
				overflow-x: hidden;
			}

			.header {
				background: #000000;
				padding: 20px;
				text-align: center;
				border-bottom: 2px solid #ff0000;
			}

			.header h1 {
				font-size: 2.5em;
				margin-bottom: 10px;
				color: #ff0000;
				font-weight: bold;
			}

			.header p {
				font-size: 1.2em;
				color: #cccccc;
			}

			.status-bar {
				background: #111111;
				padding: 15px;
				display: flex;
				justify-content: space-between;
				align-items: center;
				border-bottom: 1px solid #333333;
			}

			.status-item {
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.status-dot {
				width: 12px;
				height: 12px;
				background: #ff0000;
				animation: pulse 2s infinite;
			}

			.status-dot.online {
				background: #00ff00;
			}

			@keyframes pulse {
				0% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
				100% {
					opacity: 1;
				}
			}

			.camera-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
				gap: 20px;
				padding: 20px;
				max-width: 1400px;
				margin: 0 auto;
			}

			.camera-card {
				background: #111111;
				border: 1px solid #333333;
				overflow: hidden;
				transition: border-color 0.3s ease;
			}

			.camera-card:hover {
				border-color: #ff0000;
			}

			.camera-header {
				background: #222222;
				padding: 15px;
				display: flex;
				justify-content: space-between;
				align-items: center;
				border-bottom: 1px solid #333333;
			}

			.camera-title {
				font-size: 1.3em;
				font-weight: bold;
				color: #ff0000;
			}

			.camera-status {
				display: flex;
				align-items: center;
				gap: 8px;
				font-size: 0.9em;
			}

			.camera-feed {
				position: relative;
				width: 100%;
				height: 300px;
				background: #000000;
				display: flex;
				align-items: center;
				justify-content: center;
				border-bottom: 1px solid #333333;
			}

			.camera-feed img {
				max-width: 100%;
				max-height: 100%;
				object-fit: contain;
			}

			.loading {
				color: #666666;
				font-size: 1.1em;
			}

			.error {
				color: #ff0000;
				font-size: 1.1em;
			}

			.camera-info {
				padding: 15px;
				background: #111111;
				font-size: 0.9em;
				border-bottom: 1px solid #333333;
			}

			.info-row {
				display: flex;
				justify-content: space-between;
				margin-bottom: 8px;
			}

			.info-label {
				color: #666666;
			}

			.info-value {
				color: #ffffff;
				font-weight: bold;
			}

			.controls {
				padding: 15px;
				background: #111111;
				display: flex;
				gap: 10px;
			}

			.btn {
				padding: 8px 16px;
				border: 1px solid #333333;
				background: #000000;
				color: #ffffff;
				cursor: pointer;
				font-size: 0.9em;
				font-family: 'Courier New', monospace;
				transition: all 0.3s ease;
			}

			.btn:hover {
				border-color: #ff0000;
				color: #ff0000;
			}

			.refresh-btn {
				position: fixed;
				bottom: 30px;
				right: 30px;
				width: 60px;
				height: 60px;
				background: #000000;
				border: 2px solid #ff0000;
				color: #ff0000;
				font-size: 1.5em;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.refresh-btn:hover {
				background: #ff0000;
				color: #000000;
			}

			@media (max-width: 768px) {
				.camera-grid {
					grid-template-columns: 1fr;
					padding: 10px;
				}

				.header h1 {
					font-size: 2em;
				}

				.status-bar {
					flex-direction: column;
					gap: 10px;
				}
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>Mentat Radar</h1>
		</div>

		<div class="status-bar">
			<div class="status-item">
				<div class="status-dot" id="serverStatus"></div>
				<span>Server: <span id="serverStatusText">Connecting...</span></span>
			</div>
			<div class="status-item">
				<span
					>Cameras Online: <span id="onlineCount">0</span>/<span id="totalCount"
						>0</span
					></span
				>
			</div>
			<div class="status-item">
				<span>Last Update: <span id="lastUpdate">Never</span></span>
			</div>
		</div>

		<div class="camera-grid" id="cameraGrid">
			<!-- Cameras will be dynamically loaded here -->
		</div>

		<button
			class="refresh-btn"
			onclick="refreshAllCameras()"
			title="Refresh All Cameras"
		>
			ðŸ”„
		</button>

		<script>
			let cameras = [];
			let refreshInterval;

			// Initialize dashboard
			async function initDashboard() {
				try {
					await loadCameras();
					startAutoRefresh();
					updateServerStatus(true);
				} catch (error) {
					console.error('Failed to initialize dashboard:', error);
					updateServerStatus(false);
				}
			}

			// Load camera configuration
			async function loadCameras() {
				try {
					const response = await fetch('/api/cameras');
					cameras = await response.json();
					renderCameras();
					updateCameraCount();
				} catch (error) {
					console.error('Failed to load cameras:', error);
					showError('Failed to load camera configuration');
				}
			}

			// Render camera grid
			function renderCameras() {
				const grid = document.getElementById('cameraGrid');
				grid.innerHTML = '';

				cameras.cameras.forEach((camera, index) => {
					const card = createCameraCard(camera, index);
					grid.appendChild(card);
				});
			}

			// Create individual camera card
			function createCameraCard(camera, index) {
				const card = document.createElement('div');
				card.className = 'camera-card';
				card.innerHTML = `
                <div class="camera-header">
                    <div class="camera-title">${camera.name}</div>
                    <div class="camera-status">
                        <div class="status-dot" id="status-${index}"></div>
                        <span id="statusText-${index}">Connecting...</span>
                    </div>
                </div>
                <div class="camera-feed" id="feed-${index}">
                    <div class="loading">Loading camera feed...</div>
                </div>
                <div class="camera-info">
                    <div class="info-row">
                        <span class="info-label">IP Address:</span>
                        <span class="info-value">${camera.ip}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Camera ID:</span>
                        <span class="info-value">${camera.id}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="connectionStatus-${index}">Unknown</span>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="refreshCamera(${index})">Refresh</button>
                    <button class="btn btn-secondary" onclick="toggleStream(${index})">Toggle Stream</button>
                </div>
            `;
				return card;
			}

			// Start camera feed
			function startCameraFeed(cameraIndex) {
				const feedElement = document.getElementById(`feed-${cameraIndex}`);
				const statusElement = document.getElementById(`status-${cameraIndex}`);
				const statusTextElement = document.getElementById(
					`statusText-${cameraIndex}`
				);
				const connectionStatusElement = document.getElementById(
					`connectionStatus-${cameraIndex}`
				);

				const camera = cameras.cameras[cameraIndex];
				const img = document.createElement('img');
				img.style.display = 'none';

				img.onload = () => {
					feedElement.innerHTML = '';
					feedElement.appendChild(img);
					img.style.display = 'block';
					statusElement.className = 'status-dot online';
					statusTextElement.textContent = 'Online';
					connectionStatusElement.textContent = 'Connected';
				};

				img.onerror = () => {
					feedElement.innerHTML = '<div class="error">Camera offline</div>';
					statusElement.className = 'status-dot';
					statusTextElement.textContent = 'Offline';
					connectionStatusElement.textContent = 'Disconnected';
				};

				// Start with single frame, then switch to stream
				img.src = camera.frameUrl + '?t=' + Date.now();

				// Switch to stream after initial load
				setTimeout(() => {
					img.src = camera.streamUrl;
				}, 1000);
			}

			// Refresh single camera
			function refreshCamera(index) {
				const feedElement = document.getElementById(`feed-${index}`);
				feedElement.innerHTML = '<div class="loading">Refreshing...</div>';
				startCameraFeed(index);
			}

			// Refresh all cameras
			function refreshAllCameras() {
				cameras.cameras.forEach((_, index) => {
					refreshCamera(index);
				});
				updateLastUpdate();
			}

			// Toggle stream mode
			function toggleStream(index) {
				const feedElement = document.getElementById(`feed-${index}`);
				const img = feedElement.querySelector('img');
				if (img) {
					const camera = cameras.cameras[index];
					if (img.src.includes('/stream/')) {
						img.src = camera.frameUrl + '?t=' + Date.now();
					} else {
						img.src = camera.streamUrl;
					}
				}
			}

			// Update server status
			function updateServerStatus(online) {
				const statusDot = document.getElementById('serverStatus');
				const statusText = document.getElementById('serverStatusText');

				if (online) {
					statusDot.className = 'status-dot online';
					statusText.textContent = 'Online';
				} else {
					statusDot.className = 'status-dot';
					statusText.textContent = 'Offline';
				}
			}

			// Update camera count
			function updateCameraCount() {
				const onlineCount = document.getElementById('onlineCount');
				const totalCount = document.getElementById('totalCount');

				totalCount.textContent = cameras.cameras.length;

				// Count online cameras
				let online = 0;
				cameras.cameras.forEach((_, index) => {
					const statusDot = document.getElementById(`status-${index}`);
					if (statusDot && statusDot.classList.contains('online')) {
						online++;
					}
				});
				onlineCount.textContent = online;
			}

			// Update last update time
			function updateLastUpdate() {
				const lastUpdate = document.getElementById('lastUpdate');
				lastUpdate.textContent = new Date().toLocaleTimeString();
			}

			// Start auto-refresh
			function startAutoRefresh() {
				// Initial load
				cameras.cameras.forEach((_, index) => {
					startCameraFeed(index);
				});

				// Auto-refresh every 30 seconds
				refreshInterval = setInterval(() => {
					cameras.cameras.forEach((_, index) => {
						const img = document
							.getElementById(`feed-${index}`)
							.querySelector('img');
						if (img && img.src.includes('/frame/')) {
							img.src = cameras.cameras[index].frameUrl + '?t=' + Date.now();
						}
					});
					updateCameraCount();
					updateLastUpdate();
				}, 30000);
			}

			// Show error message
			function showError(message) {
				const grid = document.getElementById('cameraGrid');
				grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #ff4444; font-size: 1.2em;">${message}</div>`;
			}

			// Initialize when page loads
			document.addEventListener('DOMContentLoaded', initDashboard);

			// Cleanup on page unload
			window.addEventListener('beforeunload', () => {
				if (refreshInterval) {
					clearInterval(refreshInterval);
				}
			});
		</script>
	</body>
</html>
